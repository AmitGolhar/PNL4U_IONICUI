<ion-header>
  <ion-toolbar color="dark">
    <ion-title>Discover Events</ion-title>
  </ion-toolbar>

  <!-- ðŸŽ¯ Dropdown Filters -->
  <ion-toolbar class="filter-toolbar">
    <div class="filter-row">

      <!-- ðŸŒ† City Filter -->
      <ion-item class="dropdown-item city-filter" lines="none">
        <ion-label position="stacked">City</ion-label>
        <ion-select interface="popover" [(ngModel)]="selectedCity"
          [placeholder]="selectedCity ? selectedCity : 'Select City'"
          (ionChange)="applyFilters('locationCity', $event.detail.value)">
          <ion-select-option *ngFor="let city of cities" [value]="city">
            {{ city }}
          </ion-select-option>
        </ion-select>
      </ion-item>


      <!-- ðŸª© Category Filter -->
      <ion-item class="dropdown-item category-filter" lines="none">
        <ion-label position="stacked">Category</ion-label>
        <ion-select placeholder="Select Category" interface="popover"
          (ionChange)="applyFilters('category', $event.detail.value)">
          <ion-select-option *ngFor="let cat of categories" [value]="cat">
            {{ cat }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <!-- ðŸŽµ Genre Filter -->
      <ion-item class="dropdown-item genre-filter" lines="none">
        <ion-label position="stacked">Genre</ion-label>
        <ion-select placeholder="Select Genre" interface="popover"
          (ionChange)="applyFilters('genre', $event.detail.value)">
          <ion-select-option *ngFor="let genre of eventGenres" [value]="genre.value">
            {{ genre.label }}
          </ion-select-option>
        </ion-select>
      </ion-item>

    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding event-list-bg">

  <!-- ðŸ”„ Spinner while loading -->
  <ion-spinner *ngIf="loading && page === 0" class="center-spinner"></ion-spinner>

  <!-- ðŸ§¾ Event Cards -->
  <ion-list *ngIf="events.length > 0">
    <ion-card *ngFor="let e of events" class="event-card">

      <!-- ðŸ–¼ Event Flyer -->
      <img *ngIf="e.imagesBase64?.length" [src]="e.imagesBase64[0]" alt="Event Flyer" class="event-img" />

      <ion-card-header>
        <ion-card-title>{{ e.eventName }}</ion-card-title>
        <ion-card-subtitle>{{ e.venueName }} â€¢ {{ e.locationCity }}</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>

        <!-- ðŸ“… Event Meta Info -->
        <div class="event-meta">
          <p>
            <ion-icon name="calendar-outline"></ion-icon>
            {{ e.startDate | date: 'EEE, MMM d' }} â€¢ {{ e.startTime || 'IST' }}
          </p>
          <p *ngIf="e.artistName">
            <ion-icon name="musical-notes-outline"></ion-icon>
            {{ e.artistName }}
          </p>
          <p *ngIf="e.duration">
            <ion-icon name="time-outline"></ion-icon>
            {{ e.duration }}
          </p>
        </div>

        <!-- ðŸ”– Chips / Tags -->
        <div class="chips">
          <ion-chip color="primary" *ngFor="let cat of e.category?.split(',')">{{ cat }}</ion-chip>
          <ion-chip color="tertiary" *ngFor="let sub of e.subCategory?.split(',')">{{ sub }}</ion-chip>
          <ion-chip color="medium" *ngFor="let gen of e.genre?.split(',')">{{ gen }}</ion-chip>
          <ion-chip color="success" *ngFor="let tag of e.tags?.split(',')">{{ tag }}</ion-chip>
          <ion-chip color="success" *ngIf="e.eventType">{{ e.eventType }}</ion-chip>
          <ion-chip color="warning" *ngIf="e.offers">ðŸ”¥ Offers {{ e.offers }}</ion-chip>
          <ion-chip color="secondary" *ngIf="e.isWeekend">Weekend Vibes</ion-chip>
        </div>

        <!-- ðŸ’¬ Description -->
        <p class="event-description">{{ e.description }}</p>

        <!-- ðŸŽŸ Tickets Info -->
        <div *ngIf="e.tickets?.length" class="tickets">
          <h4>Tickets</h4>
          <ion-item lines="none" *ngFor="let t of e.tickets">
            <ion-label>
              <strong>{{ t.name }}</strong>
              <p>â‚¹{{ t.price }} â€¢ Qty: {{ t.quantity }}</p>
            </ion-label>
          </ion-item>
        </div>

        <!-- ðŸŽŸ Action Buttons -->
        <div class="action-section" *ngIf="e.approvalStatus === 'APPROVED'">
          <ion-button *ngIf="e.isFreeEntry" color="warning" expand="block" fill="solid" size="small"
            (click)="openBookingModal(e, 'GUESTLIST')">
            Guest List
          </ion-button>

          <ion-button color="warning" expand="block" fill="solid" size="small" (click)="openBookingModal(e, 'TABLE')">
            Book Table
          </ion-button>

          <ion-button expand="block" fill="solid" color="warning" size="small"
            [routerLink]="['/tabs/event-detail', e.eventId]">

            Event Details
          </ion-button>

        </div>

      </ion-card-content>
    </ion-card>
  </ion-list>


  <!-- ðŸš« No Events Found -->
  <div class="no-events" *ngIf="!loading && events.length === 0">
    <ion-icon name="calendar-outline"></ion-icon>
    <p>ðŸ¥² No events found. Try another city or genre!</p>

    <ion-button fill="solid" class="reset-btn" (click)="resetFilters()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Reset Filters
    </ion-button>
  </div>


  <!-- ðŸ”„ Infinite Scroll -->
  <ion-infinite-scroll (ionInfinite)="loadMore($event)" threshold="100px" *ngIf="hasMore">
    <ion-infinite-scroll-content loadingSpinner="bubbles"
      loadingText="Loading more events..."></ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <div class="content-bottom-spacer"></div>
</ion-content>