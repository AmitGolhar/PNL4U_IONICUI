<ion-header translucent>
  <ion-toolbar>
    <ion-title>Platform Analytics</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="exportCSV()">
        <ion-icon name="download-outline"></ion-icon>
        <span class="hide-xs">Export CSV</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding gradient-bg">
  <div class="analytics-wrap">

    <!-- KPI Row -->
    <div class="kpi-row">
      <div class="kpi-card" *ngFor="let k of kpis">
        <div class="kpi-head">
          <div class="label">{{ k.label }}</div>
          <div class="delta" [ngClass]="{'positive': k.delta>=0,'negative': k.delta<0}">
            {{ k.delta }}%
          </div>
        </div>
        <div class="kpi-value">{{ formatNumber(k.value) }}</div>
        <svg class="spark" [attr.width]="90" [attr.height]="24" viewBox="0 0 90 24">
          <path [attr.d]="sparklinePath(k.trend, 90, 20)" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <!-- Main chart & breakdown -->
    <div class="main-row">
      <div class="area-card">
        <div class="area-header">
          <h3>Sessions (last 30 days)</h3>
          <small class="muted">Daily session count</small>
        </div>
        <svg [attr.width]="640" [attr.height]="160" viewBox="0 0 640 140" class="area-svg">
          <path [attr.d]="areaPath(timeseries, 640, 140)" fill="url(#grad1)"></path>
          <defs>
            <linearGradient id="grad1" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#ff00b3" stop-opacity="0.35" />
              <stop offset="100%" stop-color="#8e2de2" stop-opacity="0.05" />
            </linearGradient>
          </defs>
        </svg>
      </div>

      <div class="breakdown-card">
        <h4>Platform Breakdown</h4>
        <div class="donut-wrap">
          <div class="donut">
            <!-- CSS donut segments -->
            <ng-container *ngFor="let b of breakdown; let i = index">
              <div class="slice" [style.transform]="'rotate(' + computeSliceRotation(i) + 'deg)'" [style.background]="sliceGradient(i)"></div>
            </ng-container>
            <!-- Replace the problematic total sessions line -->
              <div class="donut-center">
                <div class="big">{{ formatNumber(getTotalSessions()) }}</div>
                <div class="muted">Total</div>
              </div>

          </div>

          <div class="legend">
            <div class="legend-item" *ngFor="let b of breakdown">
              <span class="badge" [style.background]="badgeColor(b.label)"></span>
              <div>
                <div class="l1">{{ b.label }}</div>
                <small class="muted">{{ percentOf(b.value) }}% â€¢ {{ b.value }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top lists -->
    <div class="lists-row">
      <div class="list-card">
        <h4>Top Venues</h4>
        <ion-list>
          <ion-item *ngFor="let v of topVenues">
            <ion-label>
              <h3>{{ v.name }}</h3>
              <p class="muted">{{ v.extra }}</p>
            </ion-label>
            <div class="metric">{{ v.metric }}</div>
          </ion-item>
        </ion-list>
      </div>

      <div class="list-card">
        <h4>Top Offers</h4>
        <ion-list>
          <ion-item *ngFor="let o of topOffers">
            <ion-label>
              <h3>{{ o.name }}</h3>
              <p class="muted">{{ o.extra }}</p>
            </ion-label>
            <div class="metric">{{ o.metric }}</div>
          </ion-item>
        </ion-list>
      </div>
    </div>

  </div>
</ion-content>
